# nixpacks.toml

[phases.setup]
# Ensure curl is available for downloading the installer.
nixPkgs = ["curl"]

[phases.install]
# Download and install Mambaforge, with robust checks for the download.
commands = [
  # Download Mambaforge installer script (-L follows redirects, -f fails silently on errors)
  "curl -L -f -O https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-Linux-x86_64.sh || (echo 'Curl download failed' && exit 1)",
  # Check if the downloaded file exists and has a reasonable size (e.g., > 10 MB)
  "ls -lh Mambaforge-Linux-x86_64.sh || (echo 'Mambaforge installer file not found after curl' && exit 1)",
  "SIZE=$(stat -c%s Mambaforge-Linux-x86_64.sh) && [ \"$SIZE\" -gt 10000000 ] || (echo \"Mambaforge installer file is too small ($SIZE bytes), download likely failed\" && exit 1)",
  # Make the script executable
  "chmod +x Mambaforge-Linux-x86_64.sh",
  # Run the installer in batch mode, installing to /opt/conda. Add error check.
  "bash Mambaforge-Linux-x86_64.sh -b -p /opt/conda || (echo 'Mambaforge installation script failed' && exit 1)",
  # Check if the installation directory was created
  "ls -lh /opt/conda || (echo '/opt/conda not found after installation' && exit 1)",
  # Initialize conda for bash shell
  ". /opt/conda/etc/profile.d/conda.sh || (echo 'Failed to source conda.sh' && exit 1)",
  # Activate the base environment
  "conda activate base || (echo 'Failed to activate base environment' && exit 1)",
  # Create the crossroad environment using mamba
  "mamba create -n crossroad_env python=3.9 crossroad -c jitendralab -c bioconda -c conda-forge -y || (echo 'Mamba environment creation failed' && exit 1)",
  # Optional: Add commands to verify the installation in the new environment
  "conda run -n crossroad_env which python || echo 'Python not found in crossroad_env'",
  "conda run -n crossroad_env which crossroad || echo 'Crossroad executable not found in crossroad_env'",
  "conda run -n crossroad_env pip list || echo 'Failed to list packages in crossroad_env'",
]

[start]
# Run the start command within the created mamba environment.
cmd = "/opt/conda/bin/conda run -n crossroad_env uvicorn crossroad.api.main:app --host 0.0.0.0 --port $PORT --workers 1"