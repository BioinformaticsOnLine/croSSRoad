# nixpacks.toml

[phases.setup]
# Install Mamba via Nix. Mamba will handle Python and other dependencies.
nixPkgs = ["mamba"]

[phases.install]
# Set environment variable to potentially help with headless graphical issues,
# then create a mamba environment with necessary packages and channels.
commands = [
  "export QT_QPA_PLATFORM=offscreen && mamba create -n crossroad_env python=3.9 crossroad -c jitendralab -c bioconda -c conda-forge -y",
  # Optional: Add commands to verify the installation in the new environment
  "conda run -n crossroad_env which python",
  "conda run -n crossroad_env which crossroad", # Assuming 'crossroad' is an entrypoint/command
  "conda run -n crossroad_env pip list", # List packages in the mamba environment
]

[start]
# Run the start command within the created mamba environment.
cmd = "conda run -n crossroad_env uvicorn crossroad.api.main:app --host 0.0.0.0 --port $PORT --workers 1"