# nixpacks.toml

[phases.setup]
# We don't need to install mamba or python via Nixpkgs anymore.
# Mambaforge installer will provide everything.
nixPkgs = [] # Start with no specific Nix packages

[phases.install]
# Download and install Mambaforge, then create the environment.
commands = [
  # Download Mambaforge installer script
  "curl -O https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-Linux-x86_64.sh",
  # Run the installer in batch mode (-b) and install to /opt/conda (-p)
  "bash Mambaforge-Linux-x86_64.sh -b -p /opt/conda",
  # Initialize conda for bash shell
  ". /opt/conda/etc/profile.d/conda.sh",
  # Activate the base environment (necessary for subsequent conda/mamba commands)
  "conda activate base",
  # Create the crossroad environment using mamba (included in Mambaforge)
  "mamba create -n crossroad_env python=3.9 crossroad -c jitendralab -c bioconda -c conda-forge -y",
  # Optional: Add commands to verify the installation in the new environment
  "conda run -n crossroad_env which python",
  "conda run -n crossroad_env which crossroad", # Assuming 'crossroad' is an entrypoint/command
  "conda run -n crossroad_env pip list", # List packages in the mamba environment
]

[start]
# Run the start command within the created mamba environment.
# Use 'conda run' with the environment name to execute the command in that environment.
cmd = "/opt/conda/bin/conda run -n crossroad_env uvicorn crossroad.api.main:app --host 0.0.0.0 --port $PORT --workers 1"